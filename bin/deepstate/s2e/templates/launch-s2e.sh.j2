#!/bin/bash
#
# This file was automatically generated by DeepState at {{ creation_time }}
#
# This script is used to run the S2E analysis. It is a simplified version of
# s2e-env's launch-s2e.sh.
#

# Useful variables
ENV_DIR="{{ env_dir }}"
INSTALL_DIR="${ENV_DIR}/install"
THIS_DIR="$(dirname $(realpath -s ${0}))"
S2E_LAST="${THIS_DIR}/s2e-last"
TESTS_DIR="${S2E_LAST}/tests"

export S2E_CONFIG="s2e-config.lua"
export S2E_SHARED_DIR="${INSTALL_DIR}/share/libs2e"
export S2E_MAX_PROCESSES="{{ max_processes }}"
export S2E_UNBUFFERED_STREAM="1"

LIBS2E="${S2E_SHARED_DIR}/libs2e-{{ qemu_arch}}-s2e.so"
QEMU="${INSTALL_DIR}/bin/qemu-system-{{ qemu_arch }}"
DRIVE="-drive file=${ENV_DIR}/{{ rel_image_path }},format=s2e,cache=writeback"

# Run S2E
LD_PRELOAD=${LIBS2E} ${QEMU} ${DRIVE}                                   \
    -k en-us -nographic -monitor null -m {{ qemu_memory }} -enable-kvm  \
    -serial file:serial.txt {{ qemu_extra_flags }}                      \
    -loadvm {{ qemu_snapshot }}

# Copy out the tests
mkdir -p ${TESTS_DIR}
for TEST in ${S2E_LAST}/testcase-*; do
    mv ${TEST} ${TESTS_DIR}/$(md5sum ${TEST} | cut -d ' ' -f 1)
done
